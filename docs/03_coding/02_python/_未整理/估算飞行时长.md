```python
# 计算球面距离
# http://oracle-abc.wikidot.com/zh-blog:20
# 百度拾取坐标网站
# http://api.map.baidu.com/lbsapi/getpoint/index.html
from math import sin, asin, cos, radians, fabs, sqrt
 
EARTH_RADIUS=6371           # 地球平均半径，6371km
 
def hav(theta):
    s = sin(theta / 2)
    return s * s
 
def get_distance_hav(lng0, lat0, lng1, lat1):
    "用haversine公式计算球面两点间的距离。"
    # 经纬度转换成弧度
    # lng经度，lat纬度
    lat0 = radians(lat0)
    lat1 = radians(lat1)
    lng0 = radians(lng0)
    lng1 = radians(lng1)
 
    dlng = fabs(lng0 - lng1)
    dlat = fabs(lat0 - lat1)
    h = hav(dlat) + cos(lat0) * cos(lat1) * hav(dlng)
    distance = 2 * EARTH_RADIUS * asin(sqrt(h))
 
    return distance
```



线性回归计算飞行时长：

```python
# 预测
tmp['distance_sqr'] = tmp['distance'] * tmp['distance']  #distance的平方
tmp['delta_经度'] = tmp['dep_经度'] - tmp['arr_经度']  # 经度差
tmp['delta_纬度'] = tmp['dep_纬度'] - tmp['arr_纬度']  # 纬度差
train_data = tmp[~tmp['fly_min'].isna()]  # 有飞时的是训练集
test_data =  tmp[tmp['fly_min'].isna()]  # 待预测的是测试集
from sklearn.linear_model import LinearRegression
regr = LinearRegression() 
regr.fit(train_data[['distance_sqr','distance','delta_经度','delta_纬度']],train_data['fly_min'])
# print('intercept:', regr.intercept_)
# print('slope:', regr.coef_)
test_data['predicted_fly_min'] = regr.predict(test_data[['distance_sqr','distance','delta_经度','delta_纬度']])
```

